--Criando a tabela Pedidos

USE CURSO_MySQL;

CREATE TABLE PEDIDOS (
ID int unsigned NOT NULL auto_increment,
DESCRICAO vachar(45) NOT NULL,
VALOR double NOT NULL default '0'
PAGO varchar(3) NOT NULL default 'Nao',
DATA date NOT NULL,
PRIMARY KEY (ID)
);

--inserindo itens na tabela
INSERT INTO PEDIDOS (DESCRICAO, VALOR, DATA) VALUES ('TV'. 3000, '2016-06-10');
INSERT INTO PEDIDOS (DESCRICAO, VALOR, DATA) VALUES ('TV'. 3000, '2016-06-12');
INSERT INTO PEDIDOS (DESCRICAO, VALOR, DATA) VALUES ('TV'. 3000, '2016-06-14');
INSERT INTO PEDIDOS (DESCRICAO, VALOR, DATA) VALUES ('TV'. 3000, '2016-06-16');
INSERT INTO PEDIDOS (DESCRICAO, VALOR, DATA) VALUES ('TV'. 3000, '2016-06-18');

CREATE PROCEDURE 'curso_mysql'.'LIMPA_PEDIDOS' ()
BEGIN
DELETE FROM PEDIDOS WHERE PAGO= 'Nao' AND TO_DAYS(NOW)) - TO_DAYS(DATA) > 3;
END$$

--EXECUTAR PROCEDURE
SELECT * FROM PEDIDOS;
CALL LIMPA_PEDIDOS();

--CRIANDO TRIGGER QUE EXECUTA A PROCEDURE SEMPRE QUE UM NOVO ITEM E INSERIDO
--CRIANDO TABELA ESTOQUE
CREATE TABLE ESTOQUE (
ID int unsigned NOT NULL auto_increment,
DESCRICAO varchar(45) NOT NULL,
QUANTIDADE int NOT NULL,
PRIMARY KEY (ID));

--INSERINDO NOVO ITEM NA TABELA ESTOQUE
INSERT INTO ESTOQUE (DESCRICAO, QUANTIDADE) VALUES('TV', 5);

--CRIANDO TRIGGER
delimiter $$
CREATE TRIGGER T_LIMPA_PEDIDOS BEFORE INSERT ON ESTOQUE FOR EACH ROW
BEGIN
CALL LIMPA_PEDIDOS();
END$$

--EXECUTANDO TRIGGER
INSERT INTO ESTOQUE (DESCRICAO, QUANTIDADE) VALUES('DVD', 8);



